{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.1.0.0",
    "parameters": {
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
            },
            "defaultValue": "https://moodlescripts.blob.core.windows.net/scripts/Moodle/"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring",
            "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
            },
            "defaultValue": ""
        },
        "applyScriptsSwitch": {
            "defaultValue": true,
            "metadata": {
                "description": "Switch to process or bypass all scripts/extensions"
            },
            "type": "bool"
        },
        "azureBackupSwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to configure AzureBackup and enlist VM's"
            },
            "type": "bool"
        },
        "redisDeploySwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to deploy a redis cache or not. Note that certain versions of Moodle (e.g., 3.1) don't work well with Redis, so use this only for known well-working Moodle versions (e.g., 3.4)."
            },
            "type": "bool"
        },
        "vnetGwDeploySwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to deploy a virtual network gateway or not"
            },
            "type": "bool"
        },
        "installObjectFsSwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to install Moodle Object FS plugins (with Azure Blob storage)"
            },
            "type": "bool"
        },
        "installO365pluginsSwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to install Moodle Office 365 plugins. As of May 22, 2018, O365 plugins for Moodle 3.5 haven't been released, so to set this true, you must set the moodleVersion to 3.4 or below."
            },
            "type": "bool"
        },
        "installGdprPluginsSwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "(Should be used only for Moodle 3.4 & 3.3) Switch to install Moodle GDPR plugins. Note these require Moodle versions 3.4.2+ or 3.3.5+ and these are included by default in Moodle 3.5. So if you choose MOODLE_35_STABLE as your moodleVersion, do not set this to true."
            },
            "type": "bool"
        },
        "htmlLocalCopySwitch": {
            "defaultValue": true,
            "metadata": {
                "description": "Switch to create a local copy of /moodle/html or not"
            },
            "type": "bool"
        },
        "ddosSwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to create a DDoS protection plan"
            },
            "type": "bool"
        },
        "enableAccelNwForCtlrVmSwitch": {
            "defaultValue": false,
            "metadata": {
                "description": "Switch to enable Azure Accelerated Networking on the controller VM. Default to false because currently the default controller VM SKU (D1) doesn't support AN. Change this to true if you set the controller VM SKU to eligibible ones (e.g., D2) for better performance."
            },
            "type": "bool"
        },
        "enableAccelNwForOtherVmsSwitch": {
            "defaultValue": true,
            "metadata": {
                "description": "Switch to enable Azure Accelerated Networking on all other VMs. Default to true because currently the default controller VM SKU for all other VMS (D2) does support AN. Change this to false if you set the SKU of any other VMs to an ineligibible one (e.g., D1) to avoid deployment failure."
            },
            "type": "bool"
        },
        "httpsTermination": {
            "allowedValues": [
                "VMSS",
                "AppGw",
                "None"
            ],
            "defaultValue": "VMSS",
            "metadata": {
                "description": "Indicates where https termination occurs. 'VMSS' is for https termination at the VMSS instance VMs (using nginx https proxy). 'AppGw' is for https termination with an Azure Application Gateway. When selecting this, you need to specify all appGw* parameters. 'None' is for testing only with no https. 'None' may not be used with a separately configured https termination layer. If you want to use the 'None' option with your separately configured https termination layer, you'll need to update your Moodle config.php manually for $cfg->wwwroot and $cfg->sslproxy."
            },
            "type": "string"
        },
        "siteURL": {
            "defaultValue": "www.example.org",
            "metadata": {
                "description": "URL for Moodle site"
            },
            "type": "string"
        },
        "moodleVersion": {
            "allowedValues": [
                "MOODLE_39_STABLE",
                "MOODLE_38_STABLE"
            ],
            "defaultValue": "MOODLE_38_STABLE",
            "metadata": {
                "description": "The Moodle version you want to install."
            },
            "type": "string"
        },
        "sshPublicKey": {
            "metadata": {
                "description": "ssh public key"
            },
            "type": "string"
        },
        "sshUsername": {
            "defaultValue": "azureadmin",
            "metadata": {
                "description": "ssh user name"
            },
            "type": "string"
        },
        "controllerVmSku": {
            "defaultValue": "Standard_DS1_v2",
            "metadata": {
                "description": "VM size for the controller VM"
            },
            "type": "string"
        },
        "controllerOsDiskVhdUri": {
            "type": "string",
            "metadata": {
                "description": "Uri of the existing VHD in ARM standard or premium storage for controller vm"
                }
        },
        "webServerType": {
            "defaultValue": "nginx",
            "allowedValues": [
                "apache",
                "nginx"
            ],
            "metadata": {
                "description": "Web server type"
            },
            "type": "string"
        },
        "autoscaleVmSku": {
            "defaultValue": "Standard_DS2_v2",
            "metadata": {
                "description": "VM size for autoscaled web VMs"
            },
            "type": "string"
        },
        "autoscaleVmCountMax": {
            "defaultValue": 10,
            "metadata": {
                "description": "Maximum number of autoscaled web VMs"
            },
            "type": "int"
        },
        "autoscaleVmCountMin": {
            "defaultValue": 1,
            "metadata": {
                "description": "Minimum (also initial) number of autoscaled web VMs"
            },
            "type": "int"
        },
        "osDiskStorageType": {
            "defaultValue": "Premium_LRS",
            "allowedValues": [
                "Premium_LRS",
                "Standard_LRS"
            ],
            "metadata": {
                "description": "Azure storage type for all VMs' OS disks. With htmlLocalCopySwith true, Premium_LRS (SSD) is strongly recommended, as PHP files will be served from OS disks."
            },
            "type": "string"
        },
        "phpVersion": {
            "allowedValues": [
                "7.2",
                "7.3",
                "7.4"
            ],
            "defaultValue": "7.4",
            "metadata": {
                "description": "php version"
            },
            "type": "string"
        },
        "dbServerType": {
            "defaultValue": "mysql",
            "allowedValues": [
                "postgres",
                "mysql",
                "mssql"
            ],
            "metadata": {
                "description": "Database type"
            },
            "type": "string"
        },
        "environnmentName": {
            "defaultValue": "pr",
             "metadata": {
                "description": "Nome dell'ambiente di deploy.  Verr√† utilizzato come preffisso per il nome delle risorse"
            },
            "type": "string"
        },
        "dbLogin": {
            "defaultValue": "dbadmin",
            "metadata": {
                "description": "Database admin username"
            },
            "type": "string"
        },
        "mysqlPgresVcores": {
            "allowedValues": [
                1,
                2,
                4,
                8,
                16,
                32
            ],
            "defaultValue": 2,
            "metadata": {
                "description": "MySql/Postgresql vCores. For Basic tier, only 1 & 2 are allowed. For GeneralPurpose tier, 2, 4, 8, 16, 32 are allowed. For MemoryOptimized, 2, 4, 8, 16 are allowed."
            },
            "type": "int"
        },
        "mysqlPgresStgSizeGB": {
            "defaultValue": 125,
            "minValue": 5,
            "maxValue": 1024,
            "metadata": {
                "description": "MySql/Postgresql storage size in GB. Minimum 5GB, increase by 1GB, up to 1TB (1024 GB)"
            },
            "type": "int"
        },
        "mysqlPgresSkuTier": {
            "allowedValues": [
                "Basic",
                "GeneralPurpose",
                "MemoryOptimized"
            ],
            "defaultValue": "GeneralPurpose",
            "metadata": {
                "description": "MySql/Postgresql sku tier"
            },
            "type": "string"
        },
        "mysqlPgresSkuHwFamily": {
            "allowedValues": [
                "Gen4",
                "Gen5"
            ],
            "defaultValue": "Gen5",
            "metadata": {
                "description": "MySql/Postgresql sku hardware family. Central US is Gen4 only, so make sure to change this parameter to Gen4 if your deployment is on Central US."
            },
            "type": "string"
        },
        "mysqlVersion": {
            "allowedValues": [
                "5.6",
                "5.7"
            ],
            "defaultValue": "5.7",
            "metadata": {
                "description": "Mysql version"
            },
            "type": "string"
        },
        "postgresVersion": {
            "allowedValues": [
                "9.5",
                "9.6"
            ],
            "defaultValue": "9.6",
            "metadata": {
                "description": "Postgresql version"
            },
            "type": "string"
        },
        "sslEnforcement": {
            "allowedValues": [
                "Disabled",
                "Enabled"
            ],
            "defaultValue": "Disabled",
            "metadata": {
                "description": "MySql/Postgresql SSL connection"
            },
            "type": "string"
        },
        "fileServerType": {
            "defaultValue": "nfs",
            "allowedValues": [
                "gluster",
                "nfs",
                "nfs-ha",
                "nfs-byo",
                "azurefiles"
            ],
            "metadata": {
                "description": "File server type: GlusterFS, NFS, and NFS-HA (2-VM highly available NFS cluster)"
            },
            "type": "string"
        },
        "nfsByoIpExportPath": {
            "defaultValue": "",
            "metadata": {
                "description": "IP address and export path of the BYO-NFS share when fileServerType == nfs-byo. E.g., 172.16.1.8:/msazure"
            },
            "type": "string"
        },
        "osDiskVhdUri": {
            "type": "string",
            "metadata": {
                "description": "Uri of the existing VHD in ARM standard or premium storage for Vmss"
                }
        },
        "OSDiskSizeInGB": {
            "defaultValue": 256,
            "metadata": {
                "description": "OS disk size per Webserver in VMSS"
            },
            "type": "int"
        },
        "fileServerDiskSize": {
            "defaultValue": 127,
            "metadata": {
                "description": "Size per disk for gluster nodes or nfs server"
            },
            "type": "int"
        },
        "fileServerDiskCount": {
            "defaultValue": 4,
            "minValue": 2,
            "maxValue": 8,
            "metadata": {
                "description": "Number of disks in raid0 per gluster node or nfs server"
            },
            "type": "int"
        },
        "fileServerVmSku": {
            "defaultValue": "Standard_DS2_v2",
            "metadata": {
                "description": "VM size for the gluster or NFS-HA nodes"
            },
            "type": "string"
        },
        "keyVaultResourceId": {
            "defaultValue": "",
            "metadata": {
                "description": "(VMSS https termination only) Azure Resource Manager resource ID of the Key Vault in case you stored your SSL cert in an Azure Key Vault (Note that this Key Vault must have been pre-created on the same Azure region where this template is being deployed). Leave this blank if you didn't. Resource ID example: /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/xxx/providers/Microsoft.KeyVault/vaults/yyy. This value can be obtained from keyvault.sh output if you used the script to store your SSL cert in your Key Vault."
            },
            "type": "string"
        },
        "sslCertKeyVaultURL": {
            "defaultValue": "",
            "metadata": {
                "description": "(VMSS https termination only) Azure Key Vault URL for your stored SSL cert. This value can be obtained from keyvault.sh output if you used the script to store your SSL cert in your Key Vault. This parameter is ignored if the keyVaultResourceId parameter is blank."
            },
            "type": "string"
        },
        "sslCertThumbprint": {
            "defaultValue": "",
            "metadata": {
                "description": "(VMSS https termination only) Thumbprint of your stored SSL cert. This value can be obtained from keyvault.sh output if you used the script to store your SSL cert in your Key Vault. This parameter is ignored if the keyVaultResourceId parameter is blank."
            },
            "type": "string"
        },
        "caCertKeyVaultURL": {
            "defaultValue": "",
            "metadata": {
                "description": "(VMSS https termination only) Azure Key Vault URL for your stored CA (Certificate Authority) cert. This value can be obtained from keyvault.sh output if you used the script to store your CA cert in your Key Vault. This parameter is ignored if the keyVaultResourceId parameter is blank."
            },
            "type": "string"
        },
        "caCertThumbprint": {
            "defaultValue": "",
            "metadata": {
                "description": "(VMSS https termination only) Thumbprint of your stored CA cert. This value can be obtained from keyvault.sh output if you used the script to store your CA cert in your Key Vault. This parameter is ignored if the keyVaultResourceId parameter is blank."
            },
            "type": "string"
        },
        "appGwSslCertKeyVaultResourceId": {
            "defaultValue": "",
            "metadata": {
                "description": "(App Gateway https termination only) Azure Key Vault URL for your stored SSL cert, again for App Gateway https termination case only. (Note that this Key Vault must have been pre-created on the same Azure region where this template is being deployed). Leave this blank if you didn't. Resource ID example: /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/xxx/providers/Microsoft.KeyVault/vaults/yyy."
            },
            "type": "string"
        },
        "appGwSslCertKeyVaultSecretName": {
            "defaultValue": "",
            "metadata": {
                "description": "(App Gateway https termination only) Name of the Azure Key Vault secret that's stored in the previously specified Key Vault as a PFX certificate (with no password) for your site's SSL cert. This secret must be pre-populated in the specified Key Vault with the matching name."
            },
            "type": "string"
        },
        "appGwSkuName": {
            "defaultValue": "Standard_v2",
            "allowedValues": [
                "Standard_Small",
                "Standard_Medium",
                "Standard_Large",
                "Standard_v2",
                "WAF_Medium",
                "WAF_Large",
                "WAF_v2"
            ],
            "metadata": {
                "description": "(App Gateway https termination only) Name of the Applicate Gateway SKU"
            },
            "type": "string"
        },
        "appGwSkuTier": {
            "defaultValue": "Standard_v2",
            "allowedValues": [
                "Standard",
                "Standard_v2",
                "WAF",
                "WAF_v2"
            ],
            "metadata": {
                "description": "(App Gateway https termination only) Tier of the Applicate Gateway"
            },
            "type": "string"
        },
        "appGwSkuCapacity": {
            "defaultValue": 2,
            "maxValue": 10,
            "minValue": 2,
            "metadata": {
                "description": "(App Gateway https termination only) Capacity instance count) of the Applicate Gateway"
            },
            "type": "int"
        },
        "storageAccountType": {
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_ZRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "Storage Account type. This storage account is only for the Moodle ObjectFS plugin and/or the (currently disabled) Azure Files file share option"
            },
            "type": "string"
        },
        "searchType": {
            "defaultValue": "none",
            "allowedValues": [
                "none",
                "azure",
                "elastic"
            ],
            "metadata": {
                "description": "options of moodle global search"
            },
            "type": "string"
        },
        "azureSearchSku": {
            "defaultValue": "basic",
            "allowedValues": [
                "free",
                "basic",
                "standard",
                "standard2",
                "standard3"
            ],
            "metadata": {
                "description": "the search service level you want to create."
            },
            "type": "string"
        },
        "azureSearchReplicaCount": {
            "defaultValue": 3,
            "minValue": 1,
            "maxValue": 12,
            "metadata": {
                "description": "Replicas distribute search workloads across the service. You need 2 or more to support high availability (applies to Basic and Standard only)."
            },
            "type": "int"
        },
        "azureSearchPartitionCount": {
            "defaultValue": 1,
            "allowedValues": [
                1,
                2,
                3,
                4,
                6,
                12
            ],
            "metadata": {
                "description": "Partitions allow for scaling of document count as well as faster indexing by sharding your index over multiple Azure Search units."
            },
            "type": "int"
        },
        "azureSearchHostingMode": {
            "defaultValue": "default",
            "allowedValues": [
                "default",
                "highDensity"
            ],
            "metadata": {
                "description": "Applicable only for azureSearchSku set to standard3. You can set this property to enable a single, high density partition that allows up to 1000 indexes, which is much higher than the maximum indexes allowed for any other azureSearchSku."
            },
            "type": "string"
        },
        "customVnetId": {
            "defaultValue": "",
            "metadata": {
                "description": "Azure Resource ID of the Azure virtual network where you want to deploy your Moodle resources. A vnet resource ID is of the following format: /subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxxxxx/resourceGroups/gggg/providers/Microsoft.Network/virtualNetworks/vvvv. Note that this virtual network must be on the same Azure location as this template deployment location. If this parameter is blank, a new Azure virtual network will be created and used. In that case, the address space of the newly created virtual network will be */16 of the following vNetAddressSpace parameter value below."
            },
            "type": "string"
        },
        "vNetAddressSpace": {
            "defaultValue": "172.31.0.0",
            "metadata": {
                "description": "Address range for the Moodle virtual network and various subnets - presumed /16 for a newly created vnet in case customVnetId is blank. Further subneting (a number of */24 subnets starting from the xxx.yyy.zzz.0/24 will be created on a newly created vnet or your BYO-vnet (specified in customVnetId parameter)."
            },
            "type": "string"
        },
        "gatewayType": {
            "allowedValues": [
                "Vpn",
                "ER"
            ],
            "defaultValue": "Vpn",
            "metadata": {
                "description": "Virtual network gateway type"
            },
            "type": "string"
        },
        "vpnType": {
            "allowedValues": [
                "RouteBased",
                "PolicyBased"
            ],
            "defaultValue": "RouteBased",
            "metadata": {
                "description": "Virtual network gateway vpn type"
            },
            "type": "string"
        },
        "loadBalancerSku": {
            "defaultValue": "Standard",
            "allowedValues": [
                "Basic",
                "Standard"
            ],
            "metadata": {
                "description": "Loadbalancer SKU"
            },
            "type": "string"
        },
        "loadBalancerTier": {
            "defaultValue": "Regional",
            "allowedValues": [
                "Regional",
                "Global"
            ],
            "metadata": {
                "description": "Loadbalancer Tier"
            },
            "type": "string"
        },
        "loadBalancerPrivateIp": {
            "defaultValue": "172.19.129.5",
            "metadata": {
                "description": "Loadbalancer Static Private IP"
            },
            "type": "string"
        },
        "ubuntuVersion": {
            "type": "string",
            "allowedValues": [
                "16.04-LTS",
                "18.04-LTS"
            ],
            "defaultValue": "18.04-LTS"
        },
        "privateEndpoint": {
            "defaultValue": "priep",
            "metadata": {
                "description": "Private Endpoint"
            },
            "type": "string"
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Azure Location for all resources."
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "pid-738e3eec-68d4-4667-8377-c05c77c21f1b",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "networkTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'network-private.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "condition": "[not(equals(parameters('osDiskVhdUri'), ''))]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "disksTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    },
                     "osDiskVhdUri": {
                        "value": "[parameters('osDiskVhdUri')]"
                    },
                    "controllerOsDiskVhdUri": {
                        "value": "[parameters('controllerOsDiskVhdUri')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'disks.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "storageAccountTemplate",
            "dependsOn": [
                "Microsoft.Resources/deployments/networkTemplate"
            ],
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    },
                    "subnetIdPrivateEndpoint": {
                        "value": "[reference('networkTemplate').outputs.subnetIdPrivateEndpoint.value]"
                    },
                    "subnetIdWeb": {
                        "value": "[reference('networkTemplate').outputs.subnetIdWeb.value]"
                    },
                    "vNetName": {
                        "value": "[reference('networkTemplate').outputs.vNetName.value]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'storageAccount-private.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "Microsoft.Resources/deployments/networkTemplate"
            ],
            "name": "dbTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    },
                    "subnetIdPrivateEndpoint": {
                        "value": "[reference('networkTemplate').outputs.subnetIdPrivateEndpoint.value]"
                    },
                    "subnetIdWeb": {
                        "value": "[reference('networkTemplate').outputs.subnetIdWeb.value]"
                    },
                    "vNetName": {
                        "value": "[reference('networkTemplate').outputs.vNetName.value]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl, 'db-', parameters('dbServerType'), '-private.json', parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "condition": "[parameters('redisDeploySwitch')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "redisTemplate",
            "dependsOn": [
                "Microsoft.Resources/deployments/networkTemplate"
            ],
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    },
                    "subnetIdRedis": {
                        "value": "[reference('networkTemplate').outputs.subnetIdRedis.value]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl, 'redis.json', parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "Microsoft.Resources/deployments/networkTemplate",
                "Microsoft.Resources/deployments/dbTemplate",
                "Microsoft.Resources/deployments/redisTemplate",
                "Microsoft.Resources/deployments/storageAccountTemplate",
                "Microsoft.Resources/deployments/disksTemplate"
            ],
            "name": "vmSetupParamsTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    },
                    "dbFQDN": {
                        "value": "[reference('dbTemplate').outputs.dbFQDN.value]"
                    },
                    "storageAccountName": {
                        "value": "[reference('storageAccountTemplate').outputs.storageAccountName.value]"
                    },
                    "storageAccountKey": {
                        "value": "[reference('storageAccountTemplate').outputs.storageAccountKey.value]"
                    },
                    "redisKey": {
                        "value": "[if(parameters('redisDeploySwitch'), reference('redisTemplate').outputs.redisKey.value, 'None')]"
                    },
                    "azureSearchKey": {
                        "value": "[if(equals(parameters('searchType'), 'azure'), reference('searchTemplate').outputs.azureSearchKey.value, 'None')]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'vmsetupparams-private.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "Microsoft.Resources/deployments/vmSetupParamsTemplate",
                "Microsoft.Resources/deployments/networkTemplate",
                "Microsoft.Resources/deployments/dbTemplate",
                "Microsoft.Resources/deployments/redisTemplate",
                "Microsoft.Resources/deployments/storageAccountTemplate",
                "Microsoft.Resources/deployments/disksTemplate"
            ],
            "name": "controllerTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    },
                    "subnetIdWeb": {
                        "value": "[reference('networkTemplate').outputs.subnetIdWeb.value]"
                    },
                    "vmSetupParamsObj": {
                        "value": "[reference('vmSetupParamsTemplate').outputs.vmSetupParamsObj.value]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl,'controller-privatefromvhd.json',parameters('_artifactsLocationSasToken'))]"
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "Microsoft.Resources/deployments/vmSetupParamsTemplate",
                "Microsoft.Resources/deployments/controllerTemplate",
                "Microsoft.Resources/deployments/networkTemplate",
                "Microsoft.Resources/deployments/redisTemplate",
                "Microsoft.Resources/deployments/dbTemplate",
                "Microsoft.Resources/deployments/disksTemplate"
            ],
            "name": "scaleSetTemplate",
            "properties": {
                "mode": "Incremental",
                "parameters": {
                    "moodleCommon": {
                        "value": "[variables('moodleCommon')]"
                    },
                    "subnetIdWeb": {
                        "value": "[reference('networkTemplate').outputs.subnetIdWeb.value]"
                    },
                    "vmSetupParamsObj": {
                        "value": "[reference('vmSetupParamsTemplate').outputs.vmSetupParamsObj.value]"
                    }
                },
                "templateLink": {
                    "uri": "[concat(variables('moodleCommon').baseTemplateUrl, variables('customVHD'), parameters('_artifactsLocationSasToken'))]"
                }
            }
        }
    ],
    "outputs": {
        "siteURL": {
            "type": "string",
            "value": "[variables('moodleCommon').siteURL]"
        },
        "databaseDNS": {
            "type": "string",
            "value": "[reference('dbTemplate').outputs.dbFQDN.value]"
        },
        "databaseAdminUsername": {
            "type": "string",
            "value": "[variables('moodleCommon').dbUsername]"
        },
        "databaseAdminPassword": {
            "type": "string",
            "value": "[variables('moodleCommon').dbLoginPassword]"
        },
        "firstFrontendVmIP": {
            "type": "string",
            "value": "[reference('scaleSetTemplate').outputs.webvm1IP.value]"
        },
        "moodleAdminPassword": {
            "type": "string",
            "value": "[variables('moodleCommon').moodleAdminPass]"
        },
        "moodleDbUsername": {
            "type": "string",
            "value": "[variables('moodleCommon').moodleDbUserAzure]"
        },
        "moodleDbPassword": {
            "type": "string",
            "value": "[variables('moodleCommon').moodleDbPass]"
        },
        "loadBalancerDNS": {
            "type": "string",
            "value": "[variables('moodleCommon').lbDns]"
        },
        "loadBalancerSku": {
            "type": "string",
            "value": "[variables('moodleCommon').lbSku]"
        },
        "loadBalancerTier": {
            "type": "string",
            "value": "[variables('moodleCommon').lbTier]"
        }
    },
    "variables": {
        "documentation01": "This main-template calls multiple sub-templates to create the moodle system",
        "documentation02": "    recoveryservices0   - dummy template (see next statement)",
        "documentation03": "    recoveryservices1   - creates a recovery vault that will be subsequently used by the VM Backup - a paramter swtich controls whethe is is called or bypassed",
        "documentation04": "    redis               - creates a redis cache",
        "documentation05": "    postgres / mysql  - creates a postgresql / mysql server",
        "documentation06": "    vnet                - creates a virtual network with three subnets",
        "documentation07": "    elastic             - creates a elastic search cluster on a vm farm",
        "documentation08": "    gluster             - creates a gluster file system on a vm farm",
        "documentation09": "    webvmss             - creates a vm scale set",
        "documentation10": "    controller          - creates a controller VM and deploys code",
        "documentation11": "GlusterFS Sizing guidance",
        "moodleCommon": {
            "baseTemplateUrl": "[concat(parameters('_artifactsLocation'), 'nested/')]",
            "scriptLocation": "[concat(parameters('_artifactsLocation'), 'scripts/')]",
            "artifactsSasToken": "[parameters('_artifactsLocationSasToken')]",
            "appGwBePoolName": "[concat('appgw-bepool-', variables('resourceprefix'))]",
            "appGwName": "[concat('appgw-', variables('resourceprefix'))]",
            "appGwPipName": "[concat('appgw-pubip-',variables('resourceprefix'))]",
            "appGwSslCertKeyVaultResourceId": "[parameters('appGwSslCertKeyVaultResourceId')]",
            "appGwSslCertKeyVaultSecretName": "[parameters('appGwSslCertKeyVaultSecretName')]",
            "appGwSkuCapacity": "[parameters('appGwSkuCapacity')]",
            "appGwSkuName": "[parameters('appGwSkuName')]",
            "appGwSkuTier": "[parameters('appGwSkuTier')]",
            "applyScriptsSwitch": "[parameters('applyScriptsSwitch')]",
            "autoscaleVmCountMax": "[parameters('autoscaleVmCountMax')]",
            "autoscaleVmCountMin": "[parameters('autoscaleVmCountMin')]",
            "autoscaleVmSku": "[parameters('autoscaleVmSku')]",
            "azureBackupSwitch": "[parameters('azureBackupSwitch')]",
            "azureSearchHostingMode": "[parameters('azureSearchHostingMode')]",
            "azureSearchName": "[concat('azure-search-',variables('resourceprefix'))]",
            "azureSearchNameHost": "[concat('azure-search-',variables('resourceprefix'),'.search.windows.net')]",
            "azureSearchPartitionCount": "[parameters('azureSearchPartitionCount')]",
            "azureSearchReplicaCount": "[parameters('azureSearchReplicaCount')]",
            "azureSearchSku": "[parameters('azureSearchSku')]",
            "commonFunctionsScriptUri": "[concat(parameters('_artifactsLocation'),'scripts/helper_functions.sh',parameters('_artifactsLocationSasToken'))]",
            "controllerVmSku": "[parameters('controllerVmSku')]",
            "controllerosDiskVhdName": "[concat('moodl', parameters('environnmentName'), 'wevml01-osdisk')]",
            "customVnetId": "[parameters('customVnetId')]",
            "ctlrNicName": "[concat('moodl', parameters('environnmentName'), 'wevml01-nic')]",
            "ctlrNsgName": "[concat('moodl', parameters('environnmentName'), 'wevml01-nsg')]",
            "ctlrPipName": "[concat('moodl', parameters('environnmentName'), 'wevml01-pubip')]",
            "ctlrVmName": "[concat('moodl', parameters('environnmentName'), 'wevml01')]",
            "ctlrVmSecrets": "[take(variables('ctlrVmSecretsArray'), if(empty(parameters('keyVaultResourceId')), 0, 1))]",
            "dbLogin": "[parameters('dbLogin')]",
            "dbLoginPassword": "[concat(substring(uniqueString(resourceGroup().id, deployment().name), 2, 11), '*7', toUpper('pfiwb'))]",
            "dbServerType": "[parameters('dbServerType')]",
            "dbUsername": "[concat(parameters('dbLogin'), '@', variables('serverName'))]",
            "ddosPlanName": "[concat('ddos-plan-',variables('resourceprefix'))]",
            "ddosSwitch": "[parameters('ddosSwitch')]",
            "elasticScriptFilename": "install_elastic.sh",
            "enableAccelNwForCtlrVmSwitch": "[parameters('enableAccelNwForCtlrVmSwitch')]",
            "enableAccelNwForOtherVmsSwitch": "[parameters('enableAccelNwForOtherVmsSwitch')]",
            "extBeName": "[concat('moodl-', parameters('environnmentName'),'-we-ilb-backend')]",
            "extFeName": "[concat('moodl-', parameters('environnmentName'),'-we-ilb-frontend')]",
            "extOutName001": "[concat('lb-outbound001-',variables('resourceprefix'))]",
            "extOutName002": "[concat('lb-outbound002-',variables('resourceprefix'))]",
            "extNatPool": "[concat('lb-natpool-',variables('resourceprefix'))]",
            "extProbeHTTP": "[concat('lb-probe-http-',variables('resourceprefix'))]",
            "extProbeHTTPS": "[concat('lb-probe-https-',variables('resourceprefix'))]",
            "fileServerDiskCount": "[parameters('fileServerDiskCount')]",
            "fileServerDiskSize": "[parameters('fileServerDiskSize')]",
            "OSDiskSizeInGB": "[parameters('OSDiskSizeInGB')]",
            "fileServerType": "[parameters('fileServerType')]",
            "fileServerVmCount": 2,
            "fileServerVmSku": "[parameters('fileServerVmSku')]",
            "gatewayName": "[concat('vnet-gateway-',variables('resourceprefix'))]",
            "gatewayPublicIPName": "[concat('vnet-gw-ip-',variables('resourceprefix'))]",
            "gatewayType": "[parameters('gatewayType')]",
            "gfsNameRoot": "[concat('gluster-vm-',variables('resourceprefix'))]",
            "gfxAvailabilitySetName": "[concat('gluster-avset-',variables('resourceprefix'))]",
            "glusterScriptFilename": "install_gluster.sh",
            "htmlLocalCopySwitch": "[parameters('htmlLocalCopySwitch')]",
            "httpsTermination": "[parameters('httpsTermination')]",
            "installGdprPluginsSwitch": "[parameters('installGdprPluginsSwitch')]",
            "installO365pluginsSwitch": "[parameters('installO365pluginsSwitch')]",
            "installObjectFsSwitch": "[parameters('installObjectFsSwitch')]",
            "lbDns": "[concat('lb-',variables('resourceprefix'),'.',parameters('location'),'.cloudapp.azure.com')]",
            "lbSku": "[parameters('loadBalancerSku')]",
            "lbTier": "[parameters('loadBalancerTier')]",
            "lbName": "[concat('moodl-',parameters('environnmentName'),'-we-ilb-vmss')]",
            "lbOutName001": "[concat('lb-out001-',variables('resourceprefix'))]",
            "lbOutName002": "[concat('lb-out002-',variables('resourceprefix'))]",
            "lbPipName": "[concat('lb-pubip-',variables('resourceprefix'))]",
            "lbPrivateIP": "[parameters('loadBalancerPrivateIp')]",
            "lbOutPipName001": "[concat('lb-outpubip001-',variables('resourceprefix'))]",
            "lbOutPipName002": "[concat('lb-outpubip002-',variables('resourceprefix'))]",
            "location": "[parameters('location')]",
            "moodleAdminPass": "[concat(toUpper('xl'), substring(uniqueString(resourceGroup().id, deployment().name), 6, 7),',1*8')]",
            "moodleDbName": "moodle",
            "moodleDbPass": "[concat('9#36^', substring(uniqueString(resourceGroup().id, deployment().name), 5, 8), toUpper('ercq'))]",
            "moodleDbUser": "moodle",
            "moodleDbUserAzure": "[concat('moodle', '@', variables('serverName'))]",
            "moodleInstallScriptFilename": "install_moodle.sh",
            "moodleOnAzureConfigsJsonPath": "/var/lib/cloud/instance/moodle_on_azure_configs.json",
            "moodleVersion": "[parameters('moodleVersion')]",
            "mysqlPgresSkuHwFamily": "[parameters('mysqlPgresSkuHwFamily')]",
            "mysqlPgresSkuName": "[concat(if(equals(parameters('mysqlPgresSkuTier'),'Basic'),'B', if(equals(parameters('mysqlPgresSkuTier'),'GeneralPurpose'),'GP', 'MO')), '_', parameters('mysqlPgresSkuHwFamily'), '_', string(parameters('mysqlPgresVcores')))]",
            "mysqlPgresSkuTier": "[parameters('mysqlPgresSkuTier')]",
            "mysqlPgresStgSizeGB": "[parameters('mysqlPgresStgSizeGB')]",
            "mysqlPgresVcores": "[parameters('mysqlPgresVcores')]",
            "mysqlVersion": "[parameters('mysqlVersion')]",
            "mysqlPrivateEndpointName": "[concat(variables('serverName'),'-', parameters('privateEndpoint'))]",
            "mysqlPrivateDnsZoneName": "privatelink.mysql.database.azure.com",
            "nfsByoIpExportPath": "[parameters('nfsByoIpExportPath')]",
            "nfsHaClientsIPRange": "[variables('subnetWebRange')]",
            "nfsHaExportPath": "/drbd/data",
            "nfsHaLbIP": "[concat(variables('subnetSanPrefix'), '.100')]",
            "nfsHaNode0IP": "[concat(variables('subnetSanPrefix'), '.110')]",
            "nfsHaNode1IP": "[concat(variables('subnetSanPrefix'), '.120')]",
            "osDiskStorageType": "[parameters('osDiskStorageType')]",
            "osDiskVhdName": "[concat('moodl-',parameters('environnmentName'), '-we-vmss-osdisk')]",
            "osDiskName": "[concat('moodl-', parameters('environnmentName'), '-we-vmss-osdisk')]",
            "osDiskVhdimageReference": "[concat('moodl-', parameters('environnmentName'), '-we-vmss-customimage')]",
            "osDiskVhdimageControllerReference": "[concat('moodl-', parameters('environnmentName'), '-we-controller-customimage')]",
            "osType": {
                "offer": "UbuntuServer",
                "publisher": "Canonical",
                "sku": "[parameters('ubuntuVersion')]",
                "version": "latest"
            },
            "phpVersion": "[parameters('phpVersion')]",
            "policyName": "[concat('policy-',variables('resourceprefix'))]",
            "postgresVersion": "[parameters('postgresVersion')]",
            "redisCacheName": "[concat('redis-',variables('resourceprefix'))]",
            "redisDeploySwitch": "[parameters('redisDeploySwitch')]",
            "redisDns": "[concat('redis-',variables('resourceprefix'),'.redis.cache.windows.net')]",
            "resourcesPrefix": "[variables('resourceprefix')]",
            "searchType": "[parameters('searchType')]",
            "serverName": "[variables('serverName')]", //"[concat(parameters('dbServerType'), '-',variables('resourceprefix'))]",
            "siteURL": "[if(or(empty(parameters('siteURL')), equals(parameters('siteURL'), 'www.example.org')), concat(if(equals(parameters('httpsTermination'), 'AppGw'),'appgw-','lb-'),variables('resourceprefix'),'.',parameters('location'),'.cloudapp.azure.com'), parameters('siteURL'))]",
            "sshPublicKey": "[parameters('sshPublicKey')]",
            "sshUsername": "[parameters('sshUsername')]",
            "sslEnforcement": "[parameters('sslEnforcement')]",
            "storageAccountName": "[concat('moodl',parameters('environnmentName'),'westafiles')]",
            "storageAccountType": "[parameters('storageAccountType')]",
            "storageAccountPrivateEndpointName": "[tolower(concat('moodl',parameters('environnmentName'),'westafiles-', parameters('privateEndpoint')))]",
            "storageAccountPrivateFileDnsZoneName": "privatelink.file.core.windows.net",
            "subnetAppGw": "[concat('appgw-subnet-',variables('resourceprefix'))]",
            "subnetAppGwPrefix": "172.19.130",
            "subnetAppGwRange": "172.19.130.96/27",
            "subnetElastic": "[concat('elastic-subnet-',variables('resourceprefix'))]",
            "subnetElasticPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),5)))]",
            "subnetElasticRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),5)), '.0/24')]",
            "subnetGateway": "GatewaySubnet",
            "subnetGatewayPrefix": "[concat(variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),4)))]",
            "subnetGatewayRange": "[concat(variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),4)), '.0/24')]",
            "subnetPrivateEndpoint": "snet-private-ep",
            "subnetPrivateEndpointPrefix": "172.19.129",
            "subnetPrivateEndPointRange": "172.19.129.48/28",
            "subnetRedis": "snet-redis",
            "subnetRedisPrefix": "172.19.129",
            "subnetRedisRange": "172.19.129.32/28",
            "subnetSan": "[concat('san-subnet-',variables('resourceprefix'))]",
            "subnetSanPrefix": "[variables('subnetSanPrefix')]",
            "subnetSanRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),2)), '.0/24')]",
            "subnetTika": "[concat('tika-subnet-',variables('resourceprefix'))]",
            "subnetTikaPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),1)))]",
            "subnetTikaRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),1)), '.0/24')]",
            "subnetWeb": "snet-web",
            "subnetWebPrefix": "172.19.129",
            "subnetWebRange": "172.19.129.0/27",
            "thumbprintSslCert": "[if(or(empty(parameters('keyVaultResourceId')), empty(parameters('sslCertThumbprint'))), 'None', parameters('sslCertThumbprint'))]",
            "thumbprintCaCert": "[if(or(empty(parameters('keyVaultResourceId')), empty(parameters('caCertThumbprint'))), 'None', parameters('caCertThumbprint'))]",
            "vNetAddressSpace": "[parameters('vNetAddressSpace')]",
            "vaultName": "[concat('vault-',variables('resourceprefix'))]",
            "vmssName": "[concat('moodl-',parameters('environnmentName'),'-we-vmss')]",
            "vmssdStorageAccounttName": "[concat('moodl',parameters('environnmentName'),'wevmssstvm')]",
            "vmssNsgName": "[concat('moodl-', parameters('environnmentName'), '-we-vmss-nsg')]",
            "vmssNicName": "[concat('moodl-', parameters('environnmentName'), '-we-vmss-nic')]",
            "vnetGwDeploySwitch": "[parameters('vnetGwDeploySwitch')]",
            "vnetName": "[concat('vnet-',variables('resourceprefix'))]",
            "vpnType": "[parameters('vpnType')]",
            "webServerSetupScriptFilename": "setup_webserver.sh",
            "webServerType": "[parameters('webServerType')]"
        },
        "certUrlArray": [
            {
                "certificateUrl": "[parameters('sslCertKeyVaultURL')]"
            },
            {
                "certificateUrl": "[parameters('caCertKeyVaultURL')]"
            }
        ],
        "ctlrVmSecretsArray": [
            {
                "sourceVault": {
                    "id": "[parameters('keyVaultResourceId')]"
                },
                "vaultCertificates": "[take(variables('certUrlArray'), if(empty(parameters('caCertKeyVaultURL')), 1, 2))]"
            }
        ],
        "octets": "[split(parameters('vNetAddressSpace'), '.')]",
        "resourceprefix": "[substring(uniqueString(resourceGroup().id, deployment().name), 3, 6)]",
        "subnetSanPrefix": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),2)))]",
        "subnetWebRange": "[concat( variables('octets')[0], '.', variables('octets')[1], '.', string(add(int(variables('octets')[2]),0)), '.0/24')]",
        "customVHD":      "[if(equals(parameters('osDiskVhdUri'), ''), 'webvmss.json', 'webvmss-fromvhd.json')]",
        "serverName":     "[concat('moodl-',parameters('environnmentName'),'-we-',parameters('dbServerType'))]"       
    }
}
